<Deploy K8s Cluster>
1.在所有节点上配置NTP服务
    systemctl enable chronyd.service
    systemctl restart chronyd  --> run this on all masters / nodes

vi /etc/chrony.conf
  # Use the public servers from.......
  server 0.centos.pool.ntp.org iburst
  server 1.centos.pool.ntp.org iburst
  server 2.centos.pool.ntp.org iburst
  server 3.centos.pool.ntp.org iburst

在每个节点上run date核查时间同步
	
  2. 配置DNS解析
      update hosts

      172.18.0.71 master1.rhce.com master1
      172.18.0.72 master2.rhce.com master2
      172.18.0.61 node1.rhce.com node1
      172.18.0.62 node2.rhce.com node2
      172.18.0.63 node3.rhce.com node3
      172.18.0.64 node4.rhce.com node4
      172.18.0.51 stor1.rhce.com stor1
      172.18.0.52 stor2.rhce.com stor2
      172.18.0.53 stor3.rhce.com stor3
      172.18.0.54 stor4.rhce.com stor4	

3.关闭FW服务
	1. systemctl status firewalld & iptables
	2. 关闭SELinux
        setenforce 0
		vi /etc/selinux/config
        SELINUX=disabled
    3. init6
    4. 在所有节点上run getenforce to verify if disabled	

4.禁用SWAP设备
	1. free -m to verify swap is inuse now
	2. swapoff -a -->临时方法
	3. vi /etc/fstab  #swap.....

5.在所有节点上 enable lpvs module
	1. 开启ipvs 由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块
        ip_vs
        ip_vs_rr
        ip_vs_wrr
        ip_vs_sh
        nf_conntrack_ipv4
    2.加载ipvs所有模块：
        vi /etc/sysconfig/modules/ipvs.modules # 该文件保证开机自动加载,所有节点都需要执行

        cat > /etc/sysconfig/modules/ipvs.modules <<EOF
            #!/bin/bash
            ipvs_mods_dir="/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs"
            for i in $(ls $ipvs_mods_dir | grep -o "^[^.]*"); do
                /sbin/modinfo -F filename $i &> /dev/null
                if [ $? -eq 0 ]; then
                    /sbin/modprobe $i
                fi
            done
            EOF    
     # 临时生效
    modprobe -- ip_vs
    modprobe -- ip_vs_rr
    modprobe -- ip_vs_wrr
    modprobe -- ip_vs_sh
    modprobe -- nf_conntrack_ipv4
    # 永久生效
    cat > /etc/sysconfig/modules/ipvs.modules <<EOF
    modprobe -- ip_vs
    modprobe -- ip_vs_rr
    modprobe -- ip_vs_wrr
    modprobe -- ip_vs_sh
    modprobe -- nf_conntrack_ipv4
    EOF

    3. 开启ipvs支持
        # yum -y install ipset* ipvsadm
        # chmod +x /etc/sysconfig/modules/ipvs.modules
        # /etc/sysconfig/modules/ipvs.modules   # 手动执行一次开启路由转发系统初始化时已执行过 略过

# cat >> /etc/sysctl.conf << EOF
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
EOF
# modprobe br_netfilter
# sysctl -p
查看是否加载
lsmod | grep -e ip_vs
修改ConfigMap
kube-system/kube-proxy中的config.conf

    kubectl edit cm kube-proxy -n kube-system
    ···
     39行 mode: "" -> mode: "ipvs"
    ···

    # 重启所有工作节点的kube-proxy pod
    kubectl get pod -n kube-system | grep kube-proxy | awk '{system("kubectl delete pod "$1" -n kube-system")}'

    # 查看是否生效
    kubectl get pod -n kube-system --output=wide | grep kube-proxy
    
查看ipvs规则
[root@k8s-master ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.96.0.1:443 rr
  -> 192.168.0.171:6443           Masq    1      0          0
TCP  10.96.0.10:53 rr
UDP  10.96.0.10:53 rr
